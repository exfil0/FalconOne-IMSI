#!/usr/bin/env python3
"""
RANSacked Core - Base Classes and Utilities
Foundation for all RANSacked exploit payloads
"""

from dataclasses import dataclass
from typing import List, Optional
import struct
import logging

logger = logging.getLogger(__name__)

@dataclass
class ExploitPayload:
    """Container for exploit payload data"""
    packet: bytes
    protocol: str
    description: str
    success_indicators: List[str]
    metadata: Optional[dict] = None

class PacketBuilder:
    """Helper class for building protocol packets"""
    
    @staticmethod
    def build_ngap_header(procedure_code: int, pdu_type: int = 0x00) -> bytes:
        """Build NGAP message header"""
        return struct.pack('BBB', pdu_type, procedure_code, 0x00)
    
    @staticmethod
    def build_s1ap_header(procedure_code: int, pdu_type: int = 0x00) -> bytes:
        """Build S1AP message header"""
        return struct.pack('BBB', pdu_type, procedure_code, 0x00)
    
    @staticmethod
    def build_nas_header(protocol_discriminator: int, message_type: int) -> bytes:
        """Build NAS message header"""
        return struct.pack('BB', protocol_discriminator, message_type)
    
    @staticmethod
    def build_gtp_header(message_type: int, teid: int = 0) -> bytes:
        """Build GTP-U header"""
        return struct.pack('>BBHI', 0x30, message_type, 0x0000, teid)

class ASN1Builder:
    """ASN.1 encoding helper for cellular protocols"""
    
    @staticmethod
    def encode_ie(ie_id: int, value: bytes, criticality: int = 0) -> bytes:
        """Encode Information Element"""
        length = len(value)
        return struct.pack('>HBH', ie_id, criticality, length) + value
    
    @staticmethod
    def encode_sequence(items: List[bytes]) -> bytes:
        """Encode ASN.1 SEQUENCE"""
        content = b''.join(items)
        return b'\x30' + ASN1Builder._encode_length(len(content)) + content
    
    @staticmethod
    def _encode_length(length: int) -> bytes:
        """Encode ASN.1 length"""
        if length < 128:
            return bytes([length])
        else:
            length_bytes = length.to_bytes((length.bit_length() + 7) // 8, 'big')
            return bytes([0x80 | len(length_bytes)]) + length_bytes

__all__ = ['ExploitPayload', 'PacketBuilder', 'ASN1Builder']
