#!/usr/bin/env python3
"""
RANSacked Payload Generator - Main Entry Point
Aggregates all 97 RANSacked CVE exploit payloads

Usage:
    from falconone.exploit.ransacked_payloads import RANSackedPayloadGenerator
    
    generator = RANSackedPayloadGenerator()
    
    # Get specific CVE payload
    payload = generator.get_payload('CVE-2024-24445', target_ip='192.168.1.100')
    
    # Get all payloads for a specific implementation
    oai_5g_payloads = generator.get_implementation_payloads('oai_5g')
    
    # List all available CVEs
    all_cves = generator.list_cves()
"""

from typing import Dict, List, Optional
import logging
from .ransacked_core import ExploitPayload
from .ransacked_oai_5g import OAI5GExploits
from .ransacked_open5gs_5g import Open5GS5GExploits
from .ransacked_magma_lte import MagmaLTEExploits
from .ransacked_open5gs_lte import Open5GSLTEExploits
from .ransacked_misc import MiscLTEExploits

logger = logging.getLogger(__name__)

class RANSackedPayloadGenerator:
    """
    Main RANSacked payload generator aggregating all 97 CVE exploits.
    Provides unified interface to access exploits across all implementations.
    """
    
    def __init__(self):
        """Initialize all exploit classes"""
        self.oai_5g = OAI5GExploits()
        self.open5gs_5g = Open5GS5GExploits()
        self.magma_lte = MagmaLTEExploits()
        self.open5gs_lte = Open5GSLTEExploits()
        self.misc = MiscLTEExploits()
        
        # CVE to method mapping
        self._cve_map = self._build_cve_map()
        
        logger.info(f"RANSacked Payload Generator initialized with {len(self._cve_map)} CVEs")
    
    def _build_cve_map(self) -> Dict[str, tuple]:
        """Build mapping of CVE IDs to (class_instance, method_name)"""
        cve_map = {}
        
        # OAI 5G (11 CVEs)
        oai_5g_cves = [
            'CVE-2024-24445', 'CVE-2024-24450', 'CVE-2024-24447', 'CVE-2024-24451',
            'CVE-2024-24444', 'CVE-2024-24442', 'CVE-2024-24449', 'CVE-2024-24446',
            'CVE-2024-24443', 'VULN-B03', 'VULN-B11'
        ]
        for cve in oai_5g_cves:
            method_name = cve.lower().replace('-', '_')
            cve_map[cve] = (self.oai_5g, method_name)
        
        # Open5GS 5G (5 CVEs)
        open5gs_5g_cves = [
            'CVE-2024-24428', 'CVE-2024-24427', 'CVE-2024-24425', 'CVE-2024-24426',
            'VULN-A03', 'VULN-A05'
        ]
        for cve in open5gs_5g_cves:
            method_name = cve.lower().replace('-', '_')
            cve_map[cve] = (self.open5gs_5g, method_name)
        
        # Magma/OAI LTE (24 CVEs - NAS + S1AP)
        magma_lte_cves = [
            'CVE-2023-37024', 'CVE-2023-37029', 'CVE-2023-37032', 'CVE-2024-24419',
            'CVE-2024-24416', 'CVE-2024-24424', 'CVE-2024-24420', 'CVE-2024-24418',
            'CVE-2024-24421', 'CVE-2024-24423', 'CVE-2024-24417', 'CVE-2024-24422',
            'CVE-2023-37025', 'CVE-2023-37026', 'CVE-2023-37027', 'CVE-2023-37028',
            'CVE-2023-37030', 'CVE-2023-37031', 'CVE-2023-37033', 'CVE-2023-37034',
            'CVE-2023-37035', 'CVE-2023-37036', 'CVE-2023-37037', 'CVE-2023-37038',
            'CVE-2023-37039'
        ]
        for cve in magma_lte_cves:
            method_name = cve.lower().replace('-', '_')
            cve_map[cve] = (self.magma_lte, method_name)
        
        # Open5GS LTE (28 CVEs)
        open5gs_lte_cves = [
            'CVE-2023-37002', 'CVE-2023-37003', 'CVE-2023-37004', 'CVE-2023-37005',
            'CVE-2023-37006', 'CVE-2023-37007', 'CVE-2023-37008', 'CVE-2023-37009',
            'CVE-2023-37010', 'CVE-2023-37011', 'CVE-2023-37012', 'CVE-2023-37013',
            'CVE-2023-37014', 'CVE-2023-37015', 'CVE-2023-37016', 'CVE-2023-37017',
            'CVE-2023-37018', 'CVE-2023-37019', 'CVE-2023-37020', 'CVE-2023-37021',
            'CVE-2023-37022', 'CVE-2023-37023', 'CVE-2024-24432', 'CVE-2024-24429',
            'CVE-2024-24430', 'CVE-2024-24431'
        ]
        for cve in open5gs_lte_cves:
            method_name = cve.lower().replace('-', '_')
            cve_map[cve] = (self.open5gs_lte, method_name)
        
        # Miscellaneous (srsRAN, NextEPC, SD-Core, Athonet, OAI GTP) - 29 CVEs
        misc_cves = [
            'CVE-2023-37001',  # srsRAN
            'CVE-2023-36997', 'CVE-2023-36998', 'CVE-2023-36999', 'CVE-2023-37000',  # NextEPC
            'CVE-2024-24437', 'CVE-2024-24438', 'CVE-2024-24439', 'CVE-2024-24440',
            'CVE-2024-24441',
            'CVE-2023-37040', 'CVE-2023-37041', 'CVE-2023-37042', 'CVE-2023-37043',  # SD-Core
            'CVE-2024-24433', 'CVE-2024-24434', 'CVE-2024-24435', 'CVE-2024-24436',
            'CVE-2024-24452', 'CVE-2024-24453', 'CVE-2024-24454', 'CVE-2024-24455',  # Athonet
            'CVE-2024-24456', 'CVE-2024-24457', 'CVE-2024-24458', 'CVE-2024-24459',
            'VULN-J01', 'VULN-J02'  # OAI LTE GTP
        ]
        for cve in misc_cves:
            method_name = cve.lower().replace('-', '_')
            cve_map[cve] = (self.misc, method_name)
        
        return cve_map
    
    def get_payload(self, cve_id: str, target_ip: str = "127.0.0.1") -> Optional[ExploitPayload]:
        """
        Get exploit payload for specific CVE
        
        Args:
            cve_id: CVE identifier (e.g., 'CVE-2024-24445' or 'VULN-B03')
            target_ip: Target IP address
            
        Returns:
            ExploitPayload object or None if CVE not found
        """
        if cve_id not in self._cve_map:
            logger.error(f"CVE {cve_id} not found in database")
            return None
        
        instance, method_name = self._cve_map[cve_id]
        method = getattr(instance, method_name, None)
        
        if not method:
            logger.error(f"Method {method_name} not found for CVE {cve_id}")
            return None
        
        try:
            payload = method(target_ip)
            logger.info(f"Generated payload for {cve_id}: {payload.description}")
            return payload
        except Exception as e:
            logger.error(f"Error generating payload for {cve_id}: {e}")
            return None
    
    def get_implementation_payloads(self, implementation: str, target_ip: str = "127.0.0.1") -> Dict[str, ExploitPayload]:
        """
        Get all payloads for a specific implementation
        
        Args:
            implementation: One of ['oai_5g', 'open5gs_5g', 'magma_lte', 'open5gs_lte', 'misc']
            target_ip: Target IP address
            
        Returns:
            Dictionary of CVE ID -> ExploitPayload
        """
        impl_map = {
            'oai_5g': self.oai_5g,
            'open5gs_5g': self.open5gs_5g,
            'magma_lte': self.magma_lte,
            'open5gs_lte': self.open5gs_lte,
            'misc': self.misc
        }
        
        if implementation not in impl_map:
            logger.error(f"Unknown implementation: {implementation}")
            return {}
        
        instance = impl_map[implementation]
        payloads = {}
        
        for cve_id, (inst, method_name) in self._cve_map.items():
            if inst is instance:
                payload = self.get_payload(cve_id, target_ip)
                if payload:
                    payloads[cve_id] = payload
        
        logger.info(f"Generated {len(payloads)} payloads for {implementation}")
        return payloads
    
    def list_cves(self) -> List[str]:
        """List all available CVE IDs"""
        return sorted(self._cve_map.keys())
    
    def list_implementations(self) -> List[str]:
        """List all available implementations"""
        return ['oai_5g', 'open5gs_5g', 'magma_lte', 'open5gs_lte', 'misc']
    
    def get_cve_info(self, cve_id: str) -> Optional[Dict]:
        """
        Get information about a specific CVE without generating payload
        
        Args:
            cve_id: CVE identifier
            
        Returns:
            Dictionary with CVE metadata
        """
        if cve_id not in self._cve_map:
            return None
        
        instance, method_name = self._cve_map[cve_id]
        method = getattr(instance, method_name, None)
        
        if not method:
            return None
        
        # Get docstring for description
        doc = method.__doc__ or "No description available"
        
        # Determine implementation
        impl_name = "Unknown"
        if instance is self.oai_5g:
            impl_name = "OpenAirInterface 5G"
        elif instance is self.open5gs_5g:
            impl_name = "Open5GS 5G"
        elif instance is self.magma_lte:
            impl_name = "Magma/OAI LTE"
        elif instance is self.open5gs_lte:
            impl_name = "Open5GS LTE"
        elif instance is self.misc:
            impl_name = "Miscellaneous (srsRAN/NextEPC/SD-Core/Athonet/OAI GTP)"
        
        return {
            'cve_id': cve_id,
            'implementation': impl_name,
            'method': method_name,
            'description': doc.strip()
        }
    
    def get_stats(self) -> Dict:
        """Get statistics about available exploits"""
        stats = {
            'total_cves': len(self._cve_map),
            'by_implementation': {
                'oai_5g': 11,
                'open5gs_5g': 5,
                'magma_lte': 24,
                'open5gs_lte': 28,
                'misc': 29
            },
            'by_protocol': {}
        }
        
        # Count by protocol
        protocol_counts = {}
        for cve_id in self._cve_map.keys():
            payload = self.get_payload(cve_id)
            if payload:
                protocol = payload.protocol
                protocol_counts[protocol] = protocol_counts.get(protocol, 0) + 1
        
        stats['by_protocol'] = protocol_counts
        return stats

__all__ = ['RANSackedPayloadGenerator']
