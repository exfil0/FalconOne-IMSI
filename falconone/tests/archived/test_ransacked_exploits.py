"""
Integration Tests for RANSacked Exploit Payloads
Tests all 96 CVE exploit payload generation and validation

Version: 1.8.0
"""

import pytest
import logging
from typing import Dict, List
import sys
import os

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

from falconone.exploit.ransacked_payloads import RANSackedPayloadGenerator
from falconone.exploit.ransacked_core import ExploitPayload


@pytest.fixture(scope="module")
def generator():
    """Create RANSacked payload generator instance"""
    return RANSackedPayloadGenerator()


@pytest.fixture
def target_ip():
    """Default target IP for testing"""
    return "192.168.1.100"


class TestPayloadGeneration:
    """Test individual payload generation for each CVE"""
    
    def test_generator_initialization(self, generator):
        """Test generator initializes correctly"""
        assert generator is not None
        assert generator.oai_5g is not None
        assert generator.open5gs_5g is not None
        assert generator.magma_lte is not None
        assert generator.open5gs_lte is not None
        assert generator.misc is not None
    
    def test_cve_mapping_complete(self, generator):
        """Test all 96 CVEs are mapped"""
        cves = generator.list_cves()
        assert len(cves) == 96, f"Expected 96 CVEs, got {len(cves)}"
        assert 'CVE-2024-24445' in cves  # OAI 5G
        assert 'CVE-2024-24428' in cves  # Open5GS 5G
        assert 'CVE-2023-37024' in cves  # Magma LTE
        assert 'CVE-2023-37002' in cves  # Open5GS LTE
        assert 'CVE-2023-37001' in cves  # srsRAN
    
    def test_implementations_list(self, generator):
        """Test implementation listing"""
        impls = generator.list_implementations()
        assert len(impls) == 5
        assert 'oai_5g' in impls
        assert 'open5gs_5g' in impls
        assert 'magma_lte' in impls
        assert 'open5gs_lte' in impls
        assert 'misc' in impls
    
    # ==================== OAI 5G CVE Tests ====================
    
    @pytest.mark.parametrize("cve_id", [
        'CVE-2024-24445',  # NGAP null deref
        'CVE-2024-24450',  # Stack overflow
        'CVE-2024-24447',  # Empty list OOB
        'CVE-2024-24451',  # fd_set overflow
        'CVE-2024-24444',  # FD leak
        'CVE-2024-24442',  # Malformed ASN.1
        'CVE-2024-24449',  # Missing NAS-PDU
        'CVE-2024-24446',  # Missing optional IE
        'CVE-2024-24443',  # Uninitialized vector
        'VULN-B03',        # Missing capability
        'VULN-B11',        # Duplicate of CVE-2024-24447
    ])
    def test_oai_5g_payloads(self, generator, target_ip, cve_id):
        """Test OAI 5G payload generation"""
        payload = generator.get_payload(cve_id, target_ip)
        
        assert payload is not None, f"Payload generation failed for {cve_id}"
        assert isinstance(payload, ExploitPayload)
        assert payload.packet is not None
        assert len(payload.packet) > 0
        assert payload.protocol in ['NGAP', 'S1AP', 'NAS']
        assert payload.description
        assert len(payload.success_indicators) > 0
    
    # ==================== Open5GS 5G CVE Tests ====================
    
    @pytest.mark.parametrize("cve_id", [
        'CVE-2024-24428',  # Zero-length NAS
        'CVE-2024-24427',  # Malformed SUCI
        'CVE-2024-24425',  # OOB read
        'CVE-2024-24426',  # Missing IE (has 19 variants)
        'VULN-A03',        # Malformed SON
        'VULN-A05',        # Uplink SON
    ])
    def test_open5gs_5g_payloads(self, generator, target_ip, cve_id):
        """Test Open5GS 5G payload generation"""
        payload = generator.get_payload(cve_id, target_ip)
        
        assert payload is not None, f"Payload generation failed for {cve_id}"
        assert isinstance(payload, ExploitPayload)
        assert payload.packet is not None
        assert len(payload.packet) > 0
        assert payload.protocol in ['NGAP', 'NAS']
        assert payload.description
    
    # ==================== Magma/OAI LTE CVE Tests ====================
    
    @pytest.mark.parametrize("cve_id", [
        # NAS CVEs
        'CVE-2023-37024',  # Emergency Number List
        'CVE-2023-37029',  # Oversized NAS
        'CVE-2023-37032',  # Emergency Number overflow
        'CVE-2024-24419',  # TFT OOB read
        'CVE-2024-24416',  # APN buffer overflow
        'CVE-2024-24424',  # APN assertion
        'CVE-2024-24420',  # Linked TI
        'CVE-2024-24418',  # PDN Address underflow
        'CVE-2024-24421',  # Type confusion
        'CVE-2024-24423',  # ESM Container underflow
        'CVE-2024-24417',  # PCO OOB
        'CVE-2024-24422',  # PCO array overflow
        # S1AP CVEs
        'CVE-2023-37025',  # Missing ResetType
        'CVE-2023-37026',  # Missing MME-UE-S1AP-ID
        'CVE-2023-37027',  # Missing ENB-UE-S1AP-ID
    ])
    def test_magma_lte_payloads(self, generator, target_ip, cve_id):
        """Test Magma/OAI LTE payload generation"""
        payload = generator.get_payload(cve_id, target_ip)
        
        assert payload is not None, f"Payload generation failed for {cve_id}"
        assert isinstance(payload, ExploitPayload)
        assert payload.packet is not None
        assert len(payload.packet) > 0
        assert payload.protocol in ['S1AP', 'NAS']
        assert payload.description
        assert 'Magma' in payload.description or 'OAI' in payload.description
    
    # ==================== Open5GS LTE CVE Tests ====================
    
    @pytest.mark.parametrize("cve_id", [
        'CVE-2023-37002',  # S1 Setup missing IE
        'CVE-2023-37003',  # Initial Context Setup missing IE
        'CVE-2024-24432',  # UE Context Release Complete
        'CVE-2024-24429',  # Bearer-Level QoS
        'CVE-2024-24430',  # AMBR IE
        'CVE-2024-24431',  # F-TEID IE
    ])
    def test_open5gs_lte_payloads(self, generator, target_ip, cve_id):
        """Test Open5GS LTE payload generation"""
        payload = generator.get_payload(cve_id, target_ip)
        
        assert payload is not None, f"Payload generation failed for {cve_id}"
        assert isinstance(payload, ExploitPayload)
        assert payload.packet is not None
        assert len(payload.packet) > 0
        assert payload.protocol in ['S1AP', 'GTP']
        assert payload.description
        assert 'Open5GS' in payload.description
    
    # ==================== Miscellaneous CVE Tests ====================
    
    @pytest.mark.parametrize("cve_id,impl", [
        ('CVE-2023-37001', 'srsRAN'),        # Initial UE Message OOB
        ('CVE-2023-36997', 'NextEPC'),       # S1 Setup missing IE
        ('CVE-2023-37040', 'SD-Core'),       # Missing IE nil deref
        ('CVE-2024-24452', 'Athonet'),       # Missing IE null deref
        ('VULN-J01', 'OAI'),                 # GTP-U Echo extension header
        ('VULN-J02', 'OAI'),                 # GTP-U G-PDU malformed
    ])
    def test_misc_payloads(self, generator, target_ip, cve_id, impl):
        """Test miscellaneous implementation payloads"""
        payload = generator.get_payload(cve_id, target_ip)
        
        assert payload is not None, f"Payload generation failed for {cve_id}"
        assert isinstance(payload, ExploitPayload)
        assert payload.packet is not None
        assert len(payload.packet) > 0
        assert payload.protocol in ['S1AP', 'GTP', 'GTP-U']
        assert payload.description
        assert impl in payload.description


class TestImplementationFiltering:
    """Test filtering payloads by implementation"""
    
    def test_oai_5g_filtering(self, generator, target_ip):
        """Test OAI 5G implementation filtering"""
        payloads = generator.get_implementation_payloads('oai_5g', target_ip)
        assert len(payloads) == 11
        assert all('CVE-2024-24' in cve or 'VULN-B' in cve for cve in payloads.keys())
    
    def test_open5gs_5g_filtering(self, generator, target_ip):
        """Test Open5GS 5G implementation filtering"""
        payloads = generator.get_implementation_payloads('open5gs_5g', target_ip)
        assert len(payloads) == 6
        assert 'CVE-2024-24428' in payloads
        assert 'CVE-2024-24427' in payloads
    
    def test_magma_lte_filtering(self, generator, target_ip):
        """Test Magma/OAI LTE implementation filtering"""
        payloads = generator.get_implementation_payloads('magma_lte', target_ip)
        assert len(payloads) == 25  # 12 NAS + 13 S1AP
        assert 'CVE-2023-37024' in payloads
        assert 'CVE-2023-37032' in payloads
    
    def test_open5gs_lte_filtering(self, generator, target_ip):
        """Test Open5GS LTE implementation filtering"""
        payloads = generator.get_implementation_payloads('open5gs_lte', target_ip)
        assert len(payloads) == 26  # 23 S1AP + 3 GTP
        assert 'CVE-2023-37002' in payloads
        assert 'CVE-2024-24432' in payloads
    
    def test_misc_filtering(self, generator, target_ip):
        """Test miscellaneous implementation filtering"""
        payloads = generator.get_implementation_payloads('misc', target_ip)
        assert len(payloads) == 28  # srsRAN + NextEPC + SD-Core + Athonet + OAI GTP
        assert 'CVE-2023-37001' in payloads  # srsRAN
        assert 'CVE-2023-36997' in payloads  # NextEPC
        assert 'CVE-2023-37040' in payloads  # SD-Core
        assert 'CVE-2024-24452' in payloads  # Athonet
    
    def test_invalid_implementation(self, generator, target_ip):
        """Test invalid implementation returns empty dict"""
        payloads = generator.get_implementation_payloads('invalid_impl', target_ip)
        assert payloads == {}


class TestCVEInformation:
    """Test CVE information retrieval"""
    
    def test_cve_info_valid(self, generator):
        """Test CVE info retrieval for valid CVE"""
        info = generator.get_cve_info('CVE-2024-24445')
        
        assert info is not None
        assert info['cve_id'] == 'CVE-2024-24445'
        assert 'implementation' in info
        assert 'method' in info
        assert 'description' in info
        assert 'NGAP' in info['description']
    
    def test_cve_info_invalid(self, generator):
        """Test CVE info retrieval for invalid CVE"""
        info = generator.get_cve_info('CVE-9999-99999')
        assert info is None
    
    def test_stats_generation(self, generator):
        """Test statistics generation"""
        stats = generator.get_stats()
        
        assert stats['total_cves'] == 96
        assert 'by_implementation' in stats
        assert 'by_protocol' in stats
        
        # Check protocol distribution
        assert stats['by_protocol']['S1AP'] > 0
        assert stats['by_protocol']['NGAP'] > 0
        assert stats['by_protocol']['NAS'] > 0
        
        # Check implementation distribution
        assert stats['by_implementation']['oai_5g'] == 11
        assert stats['by_implementation']['open5gs_5g'] == 6
        assert stats['by_implementation']['magma_lte'] == 25
        assert stats['by_implementation']['open5gs_lte'] == 26
        assert stats['by_implementation']['misc'] == 28


class TestPayloadValidation:
    """Test payload structure and content validation"""
    
    def test_all_payloads_valid_structure(self, generator, target_ip):
        """Test all 96 payloads have valid structure"""
        failed = []
        
        for cve_id in generator.list_cves():
            payload = generator.get_payload(cve_id, target_ip)
            
            try:
                assert payload is not None
                assert isinstance(payload, ExploitPayload)
                assert payload.packet is not None
                assert isinstance(payload.packet, bytes)
                assert len(payload.packet) > 0
                assert payload.protocol in ['NGAP', 'S1AP', 'NAS', 'GTP', 'GTP-U']
                assert payload.description
                assert isinstance(payload.description, str)
                assert len(payload.success_indicators) > 0
                assert isinstance(payload.metadata, dict)
            except AssertionError as e:
                failed.append(f"{cve_id}: {str(e)}")
        
        assert len(failed) == 0, f"Failed validations:\n" + "\n".join(failed)
    
    def test_payload_sizes_reasonable(self, generator, target_ip):
        """Test payload sizes are reasonable (not empty, not excessive)"""
        for cve_id in generator.list_cves():
            payload = generator.get_payload(cve_id, target_ip)
            
            assert 10 <= len(payload.packet) <= 10000, \
                f"{cve_id}: Payload size {len(payload.packet)} bytes is unreasonable"
    
    def test_protocol_consistency(self, generator, target_ip):
        """Test protocols are consistent with CVE types"""
        ngap_count = 0
        s1ap_count = 0
        nas_count = 0
        gtp_count = 0
        
        for cve_id in generator.list_cves():
            payload = generator.get_payload(cve_id, target_ip)
            
            if '5G' in cve_id or 'CVE-2024' in cve_id:
                # 5G CVEs should primarily use NGAP
                if payload.protocol == 'NGAP':
                    ngap_count += 1
            
            if 'LTE' in payload.description or 'CVE-2023' in cve_id:
                # LTE CVEs should use S1AP
                if payload.protocol == 'S1AP':
                    s1ap_count += 1
            
            if 'NAS' in payload.description:
                if payload.protocol == 'NAS':
                    nas_count += 1
            
            if 'GTP' in payload.description:
                if payload.protocol in ['GTP', 'GTP-U']:
                    gtp_count += 1
        
        # Sanity checks
        assert ngap_count > 0, "No NGAP payloads found"
        assert s1ap_count > 0, "No S1AP payloads found"
        assert nas_count > 0, "No NAS payloads found"


class TestErrorHandling:
    """Test error handling and edge cases"""
    
    def test_null_target_ip(self, generator):
        """Test payload generation with null target IP"""
        payload = generator.get_payload('CVE-2024-24445', target_ip=None)
        # Should still generate payload (uses default)
        assert payload is not None
    
    def test_invalid_target_ip(self, generator):
        """Test payload generation with invalid target IP"""
        payload = generator.get_payload('CVE-2024-24445', target_ip='invalid')
        # Should still generate payload
        assert payload is not None
    
    def test_empty_cve_id(self, generator):
        """Test payload generation with empty CVE ID"""
        payload = generator.get_payload('', target_ip='192.168.1.100')
        assert payload is None
    
    def test_nonexistent_cve(self, generator):
        """Test payload generation for non-existent CVE"""
        payload = generator.get_payload('CVE-9999-99999', target_ip='192.168.1.100')
        assert payload is None


class TestProtocolDistribution:
    """Test protocol distribution matches expectations"""
    
    def test_protocol_counts(self, generator):
        """Test protocol distribution"""
        stats = generator.get_stats()
        proto_counts = stats['by_protocol']
        
        # Based on documentation:
        # S1AP: 62 CVEs (missing IEs, null derefs)
        # NAS: 15 CVEs (buffer overflows, underflows)
        # NGAP: 12 CVEs (null pointers, OOB)
        # GTP: 3 CVEs (malformed IEs)
        # GTP-U: 2 CVEs (extension headers)
        
        total = sum(proto_counts.values())
        assert total == 96, f"Protocol counts sum to {total}, expected 96"
        
        # Allow some flexibility due to implementation variations
        assert 10 <= proto_counts.get('NGAP', 0) <= 15
        assert 50 <= proto_counts.get('S1AP', 0) <= 65
        assert 10 <= proto_counts.get('NAS', 0) <= 20
        assert 0 <= proto_counts.get('GTP', 0) <= 5
        assert 0 <= proto_counts.get('GTP-U', 0) <= 5


# ==================== Performance Tests ====================

class TestPerformance:
    """Test payload generation performance"""
    
    def test_single_payload_generation_speed(self, generator, benchmark):
        """Test single payload generation speed"""
        def generate():
            return generator.get_payload('CVE-2024-24445', '192.168.1.100')
        
        # Should complete in under 10ms
        result = benchmark(generate)
        assert result is not None
    
    def test_bulk_payload_generation_speed(self, generator, target_ip):
        """Test generating all 96 payloads"""
        import time
        
        start = time.time()
        payloads = []
        
        for cve_id in generator.list_cves():
            payload = generator.get_payload(cve_id, target_ip)
            if payload:
                payloads.append(payload)
        
        elapsed = time.time() - start
        
        assert len(payloads) == 96
        assert elapsed < 2.0, f"Bulk generation took {elapsed:.2f}s (should be <2s)"
        
        print(f"\nâœ… Generated 96 payloads in {elapsed:.3f}s ({elapsed/96*1000:.2f}ms avg)")


# ==================== Integration Tests ====================

class TestIntegration:
    """Test integration with other FalconOne components"""
    
    def test_exploit_engine_compatibility(self, generator, target_ip):
        """Test compatibility with ExploitationEngine"""
        try:
            from falconone.exploit.exploit_engine import ExploitationEngine
            from falconone.core.config import Config
            
            config = Config()
            logger = logging.getLogger('test')
            engine = ExploitationEngine(config, logger)
            
            # Generate a payload
            payload = generator.get_payload('CVE-2024-24445', target_ip)
            
            assert payload is not None
            assert isinstance(payload.packet, bytes)
            
            # Exploit engine should be able to work with this payload
            assert engine is not None
            
        except ImportError:
            pytest.skip("ExploitationEngine not available")
    
    def test_payload_serialization(self, generator, target_ip):
        """Test payloads can be serialized"""
        import json
        import base64
        
        payload = generator.get_payload('CVE-2024-24445', target_ip)
        
        # Serialize to JSON
        serialized = {
            'packet': base64.b64encode(payload.packet).decode('utf-8'),
            'protocol': payload.protocol,
            'description': payload.description,
            'success_indicators': payload.success_indicators,
            'metadata': payload.metadata
        }
        
        json_str = json.dumps(serialized)
        assert len(json_str) > 0
        
        # Deserialize
        deserialized = json.loads(json_str)
        assert deserialized['protocol'] == payload.protocol
        assert deserialized['description'] == payload.description


if __name__ == '__main__':
    # Run tests with pytest
    pytest.main([__file__, '-v', '--tb=short'])
