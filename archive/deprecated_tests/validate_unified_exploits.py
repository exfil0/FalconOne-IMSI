#!/usr/bin/env python3
"""
FalconOne Unified Exploit Integration Validation Script

Tests the integration of RANSacked vulnerabilities into the core exploit engine.
Validates:
1. Vulnerability database loading
2. Exploit queries and filtering
3. Exploit chaining
4. Payload generation
5. API endpoints

Usage:
    python validate_unified_exploits.py
"""

import sys
import os

# Add FalconOne to path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

try:
    from falconone.exploit.vulnerability_db import get_vulnerability_database, ExploitCategory, Severity
    from falconone.exploit.payload_generator import get_payload_generator
    from falconone.core.config import Config
    import logging
    
    print("✅ Imports successful")
except ImportError as e:
    print(f"❌ Import failed: {e}")
    sys.exit(1)


def test_vulnerability_database():
    """Test vulnerability database loading and queries"""
    print("\n=== Testing Vulnerability Database ===")
    
    try:
        vuln_db = get_vulnerability_database()
        print(f"✅ Vulnerability database loaded")
        
        # Test statistics
        stats = vuln_db.get_statistics()
        print(f"✅ Total exploits: {stats['total_exploits']}")
        print(f"   - Total CVEs: {stats['total_cves']}")
        print(f"   - Native exploits: {stats['total_native']}")
        
        # Test by implementation
        print(f"\n   By Implementation:")
        for impl, count in stats['by_implementation'].items():
            print(f"     - {impl}: {count}")
        
        # Test by category
        print(f"\n   By Category:")
        for category, count in stats['by_category'].items():
            print(f"     - {category}: {count}")
        
        # Test filtering
        open5gs_exploits = vuln_db.find_exploits(
            implementation='Open5GS',
            exploitable_only=True
        )
        print(f"\n✅ Open5GS exploitable vulnerabilities: {len(open5gs_exploits)}")
        
        # Test category filtering
        dos_exploits = vuln_db.find_exploits(
            category=ExploitCategory.DENIAL_OF_SERVICE,
            exploitable_only=True
        )
        print(f"✅ DoS exploits: {len(dos_exploits)}")
        
        # Test severity filtering
        critical_exploits = vuln_db.find_exploits(
            severity=Severity.CRITICAL,
            exploitable_only=True
        )
        print(f"✅ Critical exploits: {len(critical_exploits)}")
        
        return True
        
    except Exception as e:
        print(f"❌ Vulnerability database test failed: {e}")
        import traceback
        traceback.print_exc()
        return False


def test_exploit_chaining():
    """Test exploit chaining functionality"""
    print("\n=== Testing Exploit Chaining ===")
    
    try:
        vuln_db = get_vulnerability_database()
        
        # Test chaining for CVE-2024-24428 (DoS)
        chains = vuln_db.get_exploit_chains('CVE-2024-24428')
        
        if chains:
            print(f"✅ Exploit chains for CVE-2024-24428: {len(chains)}")
            for i, chain in enumerate(chains):
                exploit_ids = [e.exploit_id for e in chain]
                names = [e.name for e in chain]
                success_rate = 1.0
                for exploit in chain:
                    success_rate *= exploit.success_rate
                
                print(f"\n   Chain {i+1}:")
                print(f"     Exploits: {' → '.join(exploit_ids)}")
                print(f"     Names: {' → '.join(names)}")
                print(f"     Combined success rate: {success_rate:.2f}")
        else:
            print(f"⚠️  No chains found for CVE-2024-24428")
        
        # Test chaining for FALCON-002 (Downgrade)
        chains = vuln_db.get_exploit_chains('FALCON-002')
        
        if chains:
            print(f"\n✅ Exploit chains for FALCON-002: {len(chains)}")
            for i, chain in enumerate(chains):
                exploit_ids = [e.exploit_id for e in chain]
                print(f"   Chain {i+1}: {' → '.join(exploit_ids)}")
        else:
            print(f"⚠️  No chains found for FALCON-002")
        
        return True
        
    except Exception as e:
        print(f"❌ Exploit chaining test failed: {e}")
        import traceback
        traceback.print_exc()
        return False


def test_payload_generation():
    """Test payload generator"""
    print("\n=== Testing Payload Generation ===")
    
    try:
        config = Config()
        logger = logging.getLogger('test')
        
        payload_gen = get_payload_generator(config, logger)
        print(f"✅ Payload generator initialized")
        
        # Test native exploit payloads
        print(f"\n   Testing native exploit payloads:")
        
        # FALCON-001: Rogue Base Station
        try:
            params = {'band': 3, 'target_mcc': '310', 'target_mnc': '150'}
            payload = payload_gen.generate_rogue_base_station(params)
            print(f"   ✅ FALCON-001 (Rogue Base Station): {len(str(payload))} bytes")
        except Exception as e:
            print(f"   ⚠️  FALCON-001 payload generation failed: {e}")
        
        # FALCON-002: Downgrade NAS
        try:
            params = {'target_ip': '192.168.1.100'}
            payload = payload_gen.generate_downgrade_nas(params)
            print(f"   ✅ FALCON-002 (Downgrade): {len(payload)} bytes")
        except Exception as e:
            print(f"   ⚠️  FALCON-002 payload generation failed: {e}")
        
        # FALCON-003: Silent SMS
        try:
            params = {'target_msisdn': '1234567890', 'message': 'test'}
            payload = payload_gen.generate_silent_sms(params)
            print(f"   ✅ FALCON-003 (Silent SMS): {len(str(payload))} bytes")
        except Exception as e:
            print(f"   ⚠️  FALCON-003 payload generation failed: {e}")
        
        # Test CVE exploit payloads
        print(f"\n   Testing CVE exploit payloads:")
        
        # CVE-2019-25113: Auth Bypass
        try:
            params = {'target_ip': '192.168.1.100'}
            payload = payload_gen.generate_auth_bypass_nas(params)
            print(f"   ✅ CVE-2019-25113 (Auth Bypass): {len(payload)} bytes")
        except Exception as e:
            print(f"   ⚠️  CVE-2019-25113 payload generation failed: {e}")
        
        # CVE-2024-24428: Zero-Length NAS
        try:
            params = {'target_ip': '192.168.1.100', 'dest_ip': '192.168.1.100'}
            payload = payload_gen.generate_zero_length_nas(params)
            print(f"   ✅ CVE-2024-24428 (Zero-Length NAS): {len(payload)} bytes")
        except Exception as e:
            print(f"   ⚠️  CVE-2024-24428 payload generation failed: {e}")
        
        return True
        
    except Exception as e:
        print(f"❌ Payload generation test failed: {e}")
        import traceback
        traceback.print_exc()
        return False


def test_exploit_engine_integration():
    """Test exploit engine integration"""
    print("\n=== Testing Exploit Engine Integration ===")
    
    try:
        from falconone.exploit.exploit_engine import ExploitationEngine
        
        config = Config()
        logger = logging.getLogger('test')
        
        exploit_engine = ExploitationEngine(config, logger)
        print(f"✅ Exploit engine initialized")
        
        if exploit_engine.vuln_db:
            print(f"✅ Vulnerability database integrated")
        else:
            print(f"⚠️  Vulnerability database not available")
            return False
        
        if exploit_engine.payload_gen:
            print(f"✅ Payload generator integrated")
        else:
            print(f"⚠️  Payload generator not available")
            return False
        
        # Test get_available_exploits
        exploits = exploit_engine.get_available_exploits(
            target_info={'implementation': 'Open5GS', 'version': '2.7.0'},
            filters={'exploitable_only': True}
        )
        
        print(f"✅ get_available_exploits(): {len(exploits)} exploits")
        
        if exploits:
            exploit = exploits[0]
            print(f"\n   Sample exploit:")
            print(f"     ID: {exploit['exploit_id']}")
            print(f"     Name: {exploit['name']}")
            print(f"     Category: {exploit['category']}")
            print(f"     Success rate: {exploit['success_rate']}")
            print(f"     Payload generator: {exploit['payload_generator']}")
        
        return True
        
    except Exception as e:
        print(f"❌ Exploit engine integration test failed: {e}")
        import traceback
        traceback.print_exc()
        return False


def test_specific_exploits():
    """Test specific exploit signatures"""
    print("\n=== Testing Specific Exploits ===")
    
    try:
        vuln_db = get_vulnerability_database()
        
        # Test FALCON-001
        exploits = [e for e in vuln_db.exploits if e.exploit_id == 'FALCON-001']
        if exploits:
            exploit = exploits[0]
            print(f"\n✅ FALCON-001 (Rogue Base Station)")
            print(f"   Name: {exploit.name}")
            print(f"   Category: {exploit.category.value}")
            print(f"   Success rate: {exploit.success_rate}")
            print(f"   Payload generator: {exploit.payload_generator}")
            print(f"   Post-exploit: {exploit.post_exploit_action}")
            print(f"   Chains with: {exploit.chain_with}")
        else:
            print(f"❌ FALCON-001 not found")
        
        # Test CVE-2024-24428
        exploits = [e for e in vuln_db.exploits if e.exploit_id == 'CVE-2024-24428']
        if exploits:
            exploit = exploits[0]
            print(f"\n✅ CVE-2024-24428 (Zero-Length NAS DoS)")
            print(f"   Name: {exploit.name}")
            print(f"   Implementation: {exploit.implementation}")
            print(f"   Affected versions: {exploit.affected_versions}")
            print(f"   Category: {exploit.category.value}")
            print(f"   Success rate: {exploit.success_rate}")
            print(f"   Payload generator: {exploit.payload_generator}")
            print(f"   Chains with: {exploit.chain_with}")
        else:
            print(f"❌ CVE-2024-24428 not found")
        
        # Test CVE-2019-25113
        exploits = [e for e in vuln_db.exploits if e.exploit_id == 'CVE-2019-25113']
        if exploits:
            exploit = exploits[0]
            print(f"\n✅ CVE-2019-25113 (Auth Bypass)")
            print(f"   Name: {exploit.name}")
            print(f"   CVSS: {exploit.cvss_score}")
            print(f"   Severity: {exploit.severity}")
            print(f"   Success rate: {exploit.success_rate}")
        else:
            print(f"❌ CVE-2019-25113 not found")
        
        return True
        
    except Exception as e:
        print(f"❌ Specific exploit test failed: {e}")
        import traceback
        traceback.print_exc()
        return False


def main():
    """Run all validation tests"""
    print("=" * 60)
    print("FalconOne Unified Exploit Integration Validation")
    print("=" * 60)
    
    results = []
    
    # Run tests
    results.append(("Vulnerability Database", test_vulnerability_database()))
    results.append(("Exploit Chaining", test_exploit_chaining()))
    results.append(("Payload Generation", test_payload_generation()))
    results.append(("Exploit Engine Integration", test_exploit_engine_integration()))
    results.append(("Specific Exploits", test_specific_exploits()))
    
    # Summary
    print("\n" + "=" * 60)
    print("VALIDATION SUMMARY")
    print("=" * 60)
    
    total = len(results)
    passed = sum(1 for _, result in results if result)
    failed = total - passed
    
    for test_name, result in results:
        status = "✅ PASS" if result else "❌ FAIL"
        print(f"{status}: {test_name}")
    
    print("\n" + "=" * 60)
    print(f"Total: {total} | Passed: {passed} | Failed: {failed}")
    
    if failed == 0:
        print("✅ ALL TESTS PASSED")
        print("=" * 60)
        return 0
    else:
        print("❌ SOME TESTS FAILED")
        print("=" * 60)
        return 1


if __name__ == '__main__':
    sys.exit(main())
