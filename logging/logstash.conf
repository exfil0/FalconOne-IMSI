# Logstash Configuration for FalconOne
# Task 4.3.5: Centralized logging with ELK Stack
# Version: 3.0.0

input {
  # Application logs from file
  file {
    path => "/app/logs/*.log"
    type => "application"
    codec => json
    start_position => "beginning"
    sincedb_path => "/var/lib/logstash/sincedb"
  }
  
  # Syslog input
  syslog {
    port => 5514
    type => "syslog"
  }
  
  # Docker logs
  tcp {
    port => 5000
    codec => json
    type => "docker"
  }
  
  # Beats input (Filebeat, Metricbeat)
  beats {
    port => 5044
    type => "beats"
  }
}

filter {
  # Parse application logs
  if [type] == "application" {
    # Extract timestamp
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
    
    # Extract log level
    if [level] {
      mutate {
        uppercase => ["level"]
      }
    }
    
    # Parse exception stack traces
    if [exc_info] {
      mutate {
        add_field => { "has_exception" => true }
      }
    }
    
    # Extract user information
    if [user_id] {
      mutate {
        add_field => { "user_present" => true }
      }
    }
    
    # Extract request information
    if [request_id] {
      mutate {
        add_field => { "correlation_id" => "%{request_id}" }
      }
    }
  }
  
  # Parse Docker logs
  if [type] == "docker" {
    # Extract container name
    if [container_name] {
      mutate {
        add_field => { "service" => "%{container_name}" }
      }
    }
    
    # Parse JSON logs
    if [log] {
      json {
        source => "log"
        target => "parsed"
      }
    }
  }
  
  # Enrich with GeoIP data
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
  
  # Add environment tags
  mutate {
    add_field => {
      "environment" => "${ENVIRONMENT:production}"
      "application" => "falconone"
    }
  }
  
  # Remove empty fields
  prune {
    whitelist_names => ["^@", "^message", "^level", "^logger", "^timestamp", "^user_id", "^request_id", "^environment", "^application"]
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
    index => "falconone-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
    user => "${ELASTICSEARCH_USER:elastic}"
    password => "${ELASTICSEARCH_PASSWORD:changeme}"
    manage_template => true
    template_name => "falconone-logs"
    template_overwrite => true
  }
  
  # Output to file for debugging (dev environment only)
  if [environment] == "development" {
    file {
      path => "/var/log/logstash/output-%{+YYYY-MM-dd}.log"
      codec => json_lines
    }
  }
  
  # Output to stdout for debugging
  # stdout {
  #   codec => rubydebug
  # }
}
